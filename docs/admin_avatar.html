<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>avatarOnn Admin</title>
    <style>
      :root {
        --bg: #f2f8f4;
        --card: #ffffff;
        --line: #d7e9de;
        --ink: #19342d;
        --muted: #6a847c;
        --brand: #24a85d;
        --brand-dark: #15743f;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        background: var(--bg);
        color: var(--ink);
      }
      .wrap {
        max-width: 1080px;
        margin: 0 auto;
        padding: 20px;
        display: grid;
        gap: 14px;
      }
      .card {
        border: 1px solid var(--line);
        border-radius: 14px;
        background: var(--card);
        padding: 14px;
      }
      .login {
        max-width: 420px;
        margin: 90px auto;
      }
      h1, h2 { margin: 0 0 10px; }
      .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      input, button {
        font: inherit;
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 10px 12px;
      }
      input { flex: 1; min-width: 220px; }
      button {
        cursor: pointer;
        background: var(--brand);
        color: #fff;
        border-color: var(--brand);
        font-weight: 700;
      }
      button.secondary {
        background: #f6fcf8;
        color: var(--ink);
        border-color: var(--line);
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(4, minmax(120px, 1fr));
        gap: 10px;
      }
      .stat {
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 10px;
        background: #fbfffd;
      }
      .stat .k { font-size: .82rem; color: var(--muted); }
      .stat .v { font-size: 1.5rem; font-weight: 800; }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th, td {
        border-bottom: 1px solid var(--line);
        text-align: left;
        padding: 9px 8px;
        font-size: .93rem;
      }
      th { color: var(--muted); font-weight: 700; }
      .muted { color: var(--muted); }
      .hidden { display: none; }
      .badge {
        display: inline-block;
        font-size: .78rem;
        border: 1px solid #95d9b5;
        color: #1a7f46;
        border-radius: 999px;
        padding: 3px 8px;
        background: #eefff5;
      }
      @media (max-width: 820px) {
        .stats { grid-template-columns: repeat(2, minmax(120px, 1fr)); }
      }
    </style>
  </head>
  <body>
    <section id="access" class="login card">
      <h1>Admin avatarOnn</h1>
      <p class="muted">Accès protégé.</p>
      <div class="row">
        <input id="admin-pass" type="password" placeholder="Mot de passe" />
        <button id="admin-login">Entrer</button>
      </div>
      <p id="admin-msg" class="muted"></p>
    </section>

    <main id="panel" class="wrap hidden">
      <section class="card">
        <h2>Vue globale</h2>
        <div class="stats">
          <div class="stat"><div class="k">Inscrits</div><div class="v" id="s-users">0</div></div>
          <div class="stat"><div class="k">Certifiés</div><div class="v" id="s-certified">0</div></div>
          <div class="stat"><div class="k">Posts</div><div class="v" id="s-posts">0</div></div>
          <div class="stat"><div class="k">Likes cumulés</div><div class="v" id="s-likes">0</div></div>
        </div>
      </section>

      <section class="card">
        <div class="row">
          <h2 style="margin-right:auto;">Utilisateurs</h2>
          <input id="search" type="text" placeholder="Rechercher pseudo / email / uid" />
          <button class="secondary" id="refresh">Rafraîchir</button>
        </div>
        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>Pseudo</th>
                <th>Email</th>
                <th>UID</th>
                <th>Niveau</th>
                <th>Abonnés</th>
                <th>Abonnements</th>
                <th>Likes total</th>
                <th>Inscription</th>
                <th>Certif</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </section>
    </main>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
      import {
        getFirestore,
        collection,
        doc,
        getDocs,
        setDoc,
        query,
        where,
        limit,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

      const ADMIN_PASSWORD = "26012006";
      const firebaseConfig = {
        apiKey: "AIzaSyCpl6TGs-Mnu5HXapj0Y-9SIfGJLxLhaDQ",
        authDomain: "avataronn-980dc.firebaseapp.com",
        projectId: "avataronn-980dc",
        storageBucket: "avataronn-980dc.firebasestorage.app",
        messagingSenderId: "139550141094",
        appId: "1:139550141094:web:b3e3151283727776342267",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const access = document.getElementById("access");
      const panel = document.getElementById("panel");
      const pass = document.getElementById("admin-pass");
      const login = document.getElementById("admin-login");
      const msg = document.getElementById("admin-msg");
      const rowsNode = document.getElementById("rows");
      const search = document.getElementById("search");
      const refreshBtn = document.getElementById("refresh");
      const sUsers = document.getElementById("s-users");
      const sCertified = document.getElementById("s-certified");
      const sPosts = document.getElementById("s-posts");
      const sLikes = document.getElementById("s-likes");

      let allUsers = [];
      let allPosts = [];

      function esc(v) {
        return String(v || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      }

      function formatDate(ts) {
        try {
          if (!ts) return "-";
          const date = typeof ts.toDate === "function" ? ts.toDate() : new Date(ts);
          if (!(date instanceof Date) || Number.isNaN(date.getTime())) return "-";
          return date.toLocaleString("fr-FR");
        } catch (_) {
          return "-";
        }
      }

      function openPanel() {
        access.classList.add("hidden");
        panel.classList.remove("hidden");
        loadAll().catch((e) => {
          console.error(e);
          msg.textContent = "Erreur de chargement admin.";
        });
      }

      login.addEventListener("click", () => {
        if (pass.value !== ADMIN_PASSWORD) {
          msg.textContent = "Mot de passe invalide.";
          return;
        }
        sessionStorage.setItem("avatar_admin_ok", "1");
        openPanel();
      });

      if (sessionStorage.getItem("avatar_admin_ok") === "1") openPanel();

      async function loadAll() {
        const usersSnap = await getDocs(query(collection(db, "users"), limit(1000)));
        allUsers = usersSnap.docs.map((d) => ({ uid: d.id, ...d.data() }));
        const postsSnap = await getDocs(query(collection(db, "posts"), limit(1000)));
        allPosts = postsSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
        render();
      }

      function render() {
        const term = search.value.trim().toLowerCase();
        const filtered = allUsers.filter((u) => {
          if (!term) return true;
          return [u.pseudo, u.email, u.uid].some((x) => String(x || "").toLowerCase().includes(term));
        });
        const certifiedCount = allUsers.filter((u) => Boolean(u.isCertified)).length;
        const likesTotal = allPosts.reduce((a, p) => a + Number(p.likesCount || 0), 0);
        sUsers.textContent = String(allUsers.length);
        sCertified.textContent = String(certifiedCount);
        sPosts.textContent = String(allPosts.length);
        sLikes.textContent = String(likesTotal);

        rowsNode.innerHTML = "";
        filtered.forEach((u) => {
          const tr = document.createElement("tr");
          tr.innerHTML =
            "<td>" +
            esc(u.pseudo || "-") +
            (u.isCertified ? ' <span class="badge">Certifié</span>' : "") +
            "</td><td>" +
            esc(u.email || "-") +
            "</td><td>" +
            esc(u.uid || "-") +
            "</td><td>" +
            String(Number(u.unlockedLevel || 1)) +
            "</td><td>" +
            String(Number(u.followersCount || 0)) +
            "</td><td>" +
            String(Number(u.followingCount || 0)) +
            "</td><td>" +
            String(Number(u.totalLikesReceived || 0)) +
            "</td><td>" +
            esc(formatDate(u.createdAt)) +
            '</td><td><button class="secondary" data-cert-uid="' +
            esc(u.uid) +
            '">' +
            (u.isCertified ? "Retirer" : "Certifier") +
            "</button></td>";
          rowsNode.appendChild(tr);
        });

        document.querySelectorAll("[data-cert-uid]").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const uid = btn.getAttribute("data-cert-uid");
            const user = allUsers.find((x) => x.uid === uid);
            if (!user) return;
            const next = !Boolean(user.isCertified);
            btn.disabled = true;
            try {
              await setDoc(doc(db, "users", uid), { isCertified: next }, { merge: true });
              user.isCertified = next;

              const postSnap = await getDocs(
                query(collection(db, "posts"), where("ownerUid", "==", uid), limit(500))
              );
              await Promise.all(
                postSnap.docs.map((p) =>
                  setDoc(doc(db, "posts", p.id), { ownerCertified: next }, { merge: true })
                )
              );
              allPosts = allPosts.map((p) => (p.ownerUid === uid ? { ...p, ownerCertified: next } : p));
              render();
            } catch (e) {
              console.error(e);
              alert("Erreur lors de la mise à jour.");
            } finally {
              btn.disabled = false;
            }
          });
        });
      }

      search.addEventListener("input", render);
      refreshBtn.addEventListener("click", () => loadAll().catch(console.error));
    </script>
  </body>
</html>
