<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>avatarOnn Admin</title>
    <style>
      :root {
        --bg: #f2f8f4;
        --card: #ffffff;
        --line: #d7e9de;
        --ink: #19342d;
        --muted: #6a847c;
        --brand: #24a85d;
        --brand-dark: #15743f;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        background: var(--bg);
        color: var(--ink);
      }
      .wrap {
        max-width: 1080px;
        margin: 0 auto;
        padding: 20px;
        display: grid;
        gap: 14px;
      }
      .card {
        border: 1px solid var(--line);
        border-radius: 14px;
        background: var(--card);
        padding: 14px;
      }
      .login {
        max-width: 420px;
        margin: 90px auto;
      }
      h1, h2 { margin: 0 0 10px; }
      .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      input, button {
        font: inherit;
        border: 1px solid var(--line);
        border-radius: 10px;
        padding: 10px 12px;
      }
      input { flex: 1; min-width: 220px; }
      button {
        cursor: pointer;
        background: var(--brand);
        color: #fff;
        border-color: var(--brand);
        font-weight: 700;
      }
      button.secondary {
        background: #f6fcf8;
        color: var(--ink);
        border-color: var(--line);
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(4, minmax(120px, 1fr));
        gap: 10px;
      }
      .stat {
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 10px;
        background: #fbfffd;
      }
      .stat .k { font-size: .82rem; color: var(--muted); }
      .stat .v { font-size: 1.5rem; font-weight: 800; }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th, td {
        border-bottom: 1px solid var(--line);
        text-align: left;
        padding: 9px 8px;
        font-size: .93rem;
      }
      th { color: var(--muted); font-weight: 700; }
      .muted { color: var(--muted); }
      .hidden { display: none; }
      .badge {
        display: inline-block;
        font-size: .78rem;
        border: 1px solid #95d9b5;
        color: #1a7f46;
        border-radius: 999px;
        padding: 3px 8px;
        background: #eefff5;
      }
      @media (max-width: 820px) {
        .stats { grid-template-columns: repeat(2, minmax(120px, 1fr)); }
      }
    </style>
  </head>
  <body>
    <section id="access" class="login card">
      <h1>Admin avatarOnn</h1>
      <p class="muted">Accès protégé.</p>
      <div class="row">
        <input id="admin-pass" type="password" placeholder="Mot de passe" />
        <button id="admin-login">Entrer</button>
      </div>
      <p id="admin-msg" class="muted"></p>
    </section>

    <main id="panel" class="wrap hidden">
      <section class="card">
        <h2>Vue globale</h2>
        <div class="row" style="margin-bottom:10px;">
          <button id="seed-community">Créer seed communauté</button>
          <button id="cleanup-seed" class="secondary">Supprimer anciens bots</button>
          <button id="rewrite-seed-comments" class="secondary">Réécrire commentaires bots</button>
        </div>
        <div class="stats">
          <div class="stat"><div class="k">Inscrits</div><div class="v" id="s-users">0</div></div>
          <div class="stat"><div class="k">Certifiés</div><div class="v" id="s-certified">0</div></div>
          <div class="stat"><div class="k">Posts</div><div class="v" id="s-posts">0</div></div>
          <div class="stat"><div class="k">Likes cumulés</div><div class="v" id="s-likes">0</div></div>
        </div>
      </section>

      <section class="card">
        <div class="row">
          <h2 style="margin-right:auto;">Utilisateurs</h2>
          <input id="search" type="text" placeholder="Rechercher pseudo / email / uid" />
          <button class="secondary" id="refresh">Rafraîchir</button>
        </div>
        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>Pseudo</th>
                <th>Email</th>
                <th>UID</th>
                <th>Niveau</th>
                <th>Abonnés</th>
                <th>Abonnements</th>
                <th>Likes total</th>
                <th>Inscription</th>
                <th>Certif</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </section>
    </main>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
      import {
        getFirestore,
        collection,
        doc,
        getDocs,
        setDoc,
        addDoc,
        writeBatch,
        serverTimestamp,
        deleteDoc,
        query,
        where,
        limit,
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

      const ADMIN_PASSWORD = "26012006";
      const firebaseConfig = {
        apiKey: "AIzaSyCpl6TGs-Mnu5HXapj0Y-9SIfGJLxLhaDQ",
        authDomain: "avataronn-980dc.firebaseapp.com",
        projectId: "avataronn-980dc",
        storageBucket: "avataronn-980dc.firebasestorage.app",
        messagingSenderId: "139550141094",
        appId: "1:139550141094:web:b3e3151283727776342267",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const access = document.getElementById("access");
      const panel = document.getElementById("panel");
      const pass = document.getElementById("admin-pass");
      const login = document.getElementById("admin-login");
      const msg = document.getElementById("admin-msg");
      const rowsNode = document.getElementById("rows");
      const search = document.getElementById("search");
      const refreshBtn = document.getElementById("refresh");
      const sUsers = document.getElementById("s-users");
      const sCertified = document.getElementById("s-certified");
      const sPosts = document.getElementById("s-posts");
      const sLikes = document.getElementById("s-likes");
      const seedCommunityBtn = document.getElementById("seed-community");
      const cleanupSeedBtn = document.getElementById("cleanup-seed");
      const rewriteSeedCommentsBtn = document.getElementById("rewrite-seed-comments");

      let allUsers = [];
      let allPosts = [];

      function esc(v) {
        return String(v || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
      }

      function formatDate(ts) {
        try {
          if (!ts) return "-";
          const date = typeof ts.toDate === "function" ? ts.toDate() : new Date(ts);
          if (!(date instanceof Date) || Number.isNaN(date.getTime())) return "-";
          return date.toLocaleString("fr-FR");
        } catch (_) {
          return "-";
        }
      }

      function openPanel() {
        access.classList.add("hidden");
        panel.classList.remove("hidden");
        loadAll().catch((e) => {
          console.error(e);
          msg.textContent = "Erreur de chargement admin.";
        });
      }

      login.addEventListener("click", () => {
        if (pass.value !== ADMIN_PASSWORD) {
          msg.textContent = "Mot de passe invalide.";
          return;
        }
        sessionStorage.setItem("avatar_admin_ok", "1");
        openPanel();
      });

      if (sessionStorage.getItem("avatar_admin_ok") === "1") openPanel();

      async function loadAll() {
        const usersSnap = await getDocs(query(collection(db, "users"), limit(1000)));
        allUsers = usersSnap.docs.map((d) => ({ uid: d.id, ...d.data() }));
        const postsSnap = await getDocs(query(collection(db, "posts"), limit(1000)));
        allPosts = postsSnap.docs.map((d) => ({ id: d.id, ...d.data() }));
        render();
      }

      function render() {
        const term = search.value.trim().toLowerCase();
        const filtered = allUsers.filter((u) => {
          if (!term) return true;
          return [u.pseudo, u.email, u.uid].some((x) => String(x || "").toLowerCase().includes(term));
        });
        const certifiedCount = allUsers.filter((u) => Boolean(u.isCertified)).length;
        const likesTotal = allPosts.reduce((a, p) => a + Number(p.likesCount || 0), 0);
        sUsers.textContent = String(allUsers.length);
        sCertified.textContent = String(certifiedCount);
        sPosts.textContent = String(allPosts.length);
        sLikes.textContent = String(likesTotal);

        rowsNode.innerHTML = "";
        filtered.forEach((u) => {
          const tr = document.createElement("tr");
          tr.innerHTML =
            "<td>" +
            esc(u.pseudo || "-") +
            (u.isCertified ? ' <span class="badge">Certifié</span>' : "") +
            "</td><td>" +
            esc(u.email || "-") +
            "</td><td>" +
            esc(u.uid || "-") +
            "</td><td>" +
            String(Number(u.unlockedLevel || 1)) +
            "</td><td>" +
            String(Number(u.followersCount || 0)) +
            "</td><td>" +
            String(Number(u.followingCount || 0)) +
            "</td><td>" +
            String(Number(u.totalLikesReceived || 0)) +
            "</td><td>" +
            esc(formatDate(u.createdAt)) +
            '</td><td><button class="secondary" data-cert-uid="' +
            esc(u.uid) +
            '">' +
            (u.isCertified ? "Retirer" : "Certifier") +
            "</button></td>";
          rowsNode.appendChild(tr);
        });

        document.querySelectorAll("[data-cert-uid]").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const uid = btn.getAttribute("data-cert-uid");
            const user = allUsers.find((x) => x.uid === uid);
            if (!user) return;
            const next = !Boolean(user.isCertified);
            btn.disabled = true;
            try {
              await setDoc(doc(db, "users", uid), { isCertified: next }, { merge: true });
              user.isCertified = next;

              const postSnap = await getDocs(
                query(collection(db, "posts"), where("ownerUid", "==", uid), limit(500))
              );
              await Promise.all(
                postSnap.docs.map((p) =>
                  setDoc(doc(db, "posts", p.id), { ownerCertified: next }, { merge: true })
                )
              );
              allPosts = allPosts.map((p) => (p.ownerUid === uid ? { ...p, ownerCertified: next } : p));
              render();
            } catch (e) {
              console.error(e);
              alert("Erreur lors de la mise à jour.");
            } finally {
              btn.disabled = false;
            }
          });
        });
      }

      function randInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }

      function pick(arr) {
        return arr[randInt(0, arr.length - 1)];
      }

      function topicKeyFromPostLike(postLike) {
        const text = (
          String(postLike.desc || postLike.description || "") +
          " " +
          String(postLike.q || "") +
          " " +
          String((postLike.questions && postLike.questions[0] && postLike.questions[0].text) || "")
        ).toLowerCase();
        if (text.includes("lo'ak") || text.includes("loak")) return "loak";
        if (text.includes("kiri")) return "kiri";
        if (text.includes("neteyam")) return "neteyam";
        if (text.includes("neytiri")) return "neytiri";
        if (text.includes("toruk")) return "toruk";
        if (text.includes("jake")) return "jake";
        if (text.includes("metkayina") || text.includes("way of water")) return "metkayina";
        if (text.includes("eywa")) return "eywa";
        return "avatar";
      }

      const COMMENT_CATALOG = {
        loak: {
          roots: [
            "Lo'ak a vraiment une énergie de rebelle, ça ressort direct sur ce plan.",
            "Ce visuel de Lo'ak est lourd, on sent trop son côté impulsif.",
            "Je trouve que cette scène montre bien son évolution dans le film.",
            "Le post est bien choisi, Lo'ak est intense ici.",
            "Cette image résume bien le perso: brut mais touchant.",
            "Là on voit clairement pourquoi Lo'ak marque autant les gens.",
          ],
          replies: [
            "@{user} oui clairement, cette scène le résume trop bien.",
            "@{user} je suis d'accord, c'est un de ses meilleurs moments.",
            "@{user} pas faux, surtout son regard sur ce shot.",
            "@{user} j'ai eu la même lecture que toi.",
          ],
        },
        kiri: {
          roots: [
            "Kiri a une vibe unique, ce post le montre super bien.",
            "Son aura mystique ressort de fou sur cette image.",
            "Franchement Kiri est à part dans la saga, ça se voit direct ici.",
            "Le choix de scène est excellent pour parler de Kiri.",
            "J'adore ce plan, il capture vraiment sa sensibilité.",
            "Ce post met bien en avant son côté spirituel.",
          ],
          replies: [
            "@{user} oui, c'est exactement ce qui rend Kiri spéciale.",
            "@{user} je valide, cette scène est ultra marquante.",
            "@{user} même avis, elle a une présence différente des autres.",
            "@{user} totalement d'accord avec ton point.",
          ],
        },
        neteyam: {
          roots: [
            "Neteyam dégage un vrai calme de leader sur ce plan.",
            "Ce post est propre, on voit direct son côté protecteur.",
            "Le regard de Neteyam ici est super fort.",
            "Cette scène montre bien pourquoi il impose autant.",
            "On sent bien sa maturité dans cette image.",
            "Très bon choix de visuel pour Neteyam.",
          ],
          replies: [
            "@{user} réel, il a une présence de leader.",
            "@{user} oui, ce regard il est incroyable.",
            "@{user} je suis d'accord, scène très forte.",
            "@{user} grave, c'est un de ses meilleurs plans.",
          ],
        },
        neytiri: {
          roots: [
            "Neytiri impose trop sur ce plan, c'est net.",
            "Ce visuel montre bien sa force et sa précision.",
            "Très bon post, on ressent son intensité directe.",
            "Cette scène de Neytiri est vraiment iconique.",
            "Le regard est incroyable ici.",
            "Franchement rien à dire, choix parfait pour Neytiri.",
          ],
          replies: [
            "@{user} oui, elle domine clairement la scène.",
            "@{user} totalement, ce plan est culte.",
            "@{user} je vois la même chose, grosse présence.",
            "@{user} vrai, l'image est super bien choisie.",
          ],
        },
        toruk: {
          roots: [
            "La scène de vol est folle, gros frisson.",
            "Toruk reste l'un des moments les plus marquants de la saga.",
            "Ce visuel donne trop envie de revoir la scène entière.",
            "Très bon post, la sensation de vitesse est bien là.",
            "Le plan est magnifique, c'est du pur Avatar.",
            "On sent direct le côté légendaire de Toruk ici.",
          ],
          replies: [
            "@{user} oui, cette scène est mythique.",
            "@{user} pareil, gros frisson à chaque fois.",
            "@{user} je valide, ce moment est légendaire.",
            "@{user} entièrement d'accord.",
          ],
        },
        jake: {
          roots: [
            "Le duo Jake/Neytiri fonctionne toujours aussi bien.",
            "Très bon post, on ressent la force du lien entre eux.",
            "Ce visuel résume bien l'ADN de la saga.",
            "La dynamique du duo est super bien captée.",
            "Iconique, rien d'autre à dire.",
            "Ce plan est parfait pour parler de famille Sully.",
          ],
          replies: [
            "@{user} oui, ce duo porte une grosse partie de l'histoire.",
            "@{user} d'accord avec toi, scène super forte.",
            "@{user} grave, leur dynamique est unique.",
            "@{user} totalement, post bien senti.",
          ],
        },
        metkayina: {
          roots: [
            "L'ambiance Way of Water est trop bien rendue ici.",
            "Ce post donne vraiment la vibe Metkayina.",
            "Très bon choix, on sent bien le côté océanique.",
            "Le visuel est propre, ça respire le film 2.",
            "On voit direct l'identité du clan marin.",
            "Ce plan est superbe, très bonne sélection.",
          ],
          replies: [
            "@{user} oui, la vibe marine est hyper présente.",
            "@{user} je valide, c'est très Way of Water.",
            "@{user} vrai, ce plan représente bien ce clan.",
            "@{user} même ressenti ici.",
          ],
        },
        eywa: {
          roots: [
            "Le post capture bien le côté spirituel lié à Eywa.",
            "Très bonne scène, on ressent vraiment la connexion.",
            "Cette ambiance mystique est super bien rendue.",
            "Le visuel est cohérent avec le thème Eywa.",
            "J'aime bien ce choix, c'est très contemplatif.",
            "Ça représente bien la dimension spirituelle d'Avatar.",
          ],
          replies: [
            "@{user} oui, c'est exactement cette vibe-là.",
            "@{user} je suis d'accord, ambiance très spirituelle.",
            "@{user} bien vu, la connexion est bien montrée.",
            "@{user} clair, ce thème est bien traité.",
          ],
        },
        avatar: {
          roots: [
            "Le post est propre et l'image est bien choisie.",
            "Bonne publication, ça donne envie de débattre.",
            "Franchement c'est un bon visuel pour la commu.",
            "Le thème est clair, c'est agréable à lire.",
            "J'aime bien ce genre de post simple et efficace.",
            "Très bon choix d'image et de sujet.",
          ],
          replies: [
            "@{user} oui, c'est bien vu.",
            "@{user} d'accord avec toi.",
            "@{user} je valide ton commentaire.",
            "@{user} bien résumé.",
          ],
        },
      };

      const COMMENT_CATALOG_EN = {
        loak: {
          roots: [
            "Lo'ak's rebellious energy is obvious in this shot.",
            "This visual captures Lo'ak perfectly.",
            "Great scene choice, his character arc shows well here.",
            "Lo'ak feels intense and real on this frame.",
          ],
          replies: [
            "@{user} fully agree on that scene.",
            "@{user} same feeling here.",
            "@{user} good take, that moment is strong.",
          ],
        },
        kiri: {
          roots: [
            "Kiri has such a unique aura in this scene.",
            "This post captures Kiri's mystic vibe really well.",
            "Great visual choice for Kiri.",
            "Her presence feels totally different here.",
          ],
          replies: [
            "@{user} yes, that's exactly Kiri's vibe.",
            "@{user} agreed, very memorable scene.",
            "@{user} same, she stands out a lot.",
          ],
        },
        neteyam: {
          roots: [
            "Neteyam gives calm leader energy in this shot.",
            "You can really feel his protective side here.",
            "Great frame choice for Neteyam.",
            "His expression is super strong in this scene.",
          ],
          replies: [
            "@{user} true, very leader-like.",
            "@{user} agreed, strong moment.",
            "@{user} same read from me.",
          ],
        },
        neytiri: {
          roots: [
            "Neytiri's intensity is insane in this frame.",
            "Great post, the shot is iconic.",
            "Her presence dominates the scene here.",
            "Perfect image choice for Neytiri.",
          ],
          replies: [
            "@{user} totally, she owns this scene.",
            "@{user} same opinion here.",
            "@{user} yes, iconic moment.",
          ],
        },
        toruk: {
          roots: [
            "The flight scene still gives chills.",
            "Toruk moments are always legendary.",
            "This visual makes me want to rewatch that sequence.",
            "Great post, pure Avatar energy.",
          ],
          replies: [
            "@{user} exactly, that scene is legendary.",
            "@{user} same, huge chills.",
            "@{user} yes, one of the best moments.",
          ],
        },
        jake: {
          roots: [
            "Jake/Neytiri chemistry is still top tier.",
            "This post captures their dynamic really well.",
            "Great scene to represent the saga's core.",
            "Iconic duo, no debate.",
          ],
          replies: [
            "@{user} agreed, their dynamic is unique.",
            "@{user} yes, very strong scene.",
            "@{user} same thought.",
          ],
        },
        metkayina: {
          roots: [
            "This gives strong Way of Water vibes.",
            "Great Metkayina atmosphere in this post.",
            "The marine tone is really well captured.",
            "Perfect visual for that ocean-clan vibe.",
          ],
          replies: [
            "@{user} yes, very Way of Water.",
            "@{user} fully agree with that.",
            "@{user} same vibe for me.",
          ],
        },
        eywa: {
          roots: [
            "This post captures the Eywa spiritual tone very well.",
            "Great mystical atmosphere in this scene.",
            "The visual fits the Eywa theme perfectly.",
            "Beautiful and contemplative shot.",
          ],
          replies: [
            "@{user} yes, very spiritual vibe.",
            "@{user} agreed, beautiful atmosphere.",
            "@{user} same interpretation.",
          ],
        },
        avatar: {
          roots: [
            "Clean post and good visual choice.",
            "Nice publication, good topic.",
            "Simple and effective post format.",
            "Great shot for discussion.",
          ],
          replies: [
            "@{user} agreed.",
            "@{user} good point.",
            "@{user} same opinion.",
          ],
        },
      };

      function pickManualLine(lines, localUsed, globalUsed) {
        for (const line of lines) {
          const key = String(line).toLowerCase().trim();
          if (localUsed.has(key) || globalUsed.has(key)) continue;
          localUsed.add(key);
          globalUsed.add(key);
          return line;
        }
        const fallback = lines[0] || "Post validé.";
        const fallbackKey = String(fallback).toLowerCase().trim();
        localUsed.add(fallbackKey);
        globalUsed.add(fallbackKey);
        return fallback;
      }

      function getCommentPack(key, lang) {
        const source = String(lang || "fr").toLowerCase() === "en" ? COMMENT_CATALOG_EN : COMMENT_CATALOG;
        return source[key] || source.avatar;
      }

      function makeSeedComment(tpl, localUsedComments, globalUsedComments, lang = "fr") {
        const key = topicKeyFromPostLike(tpl);
        const pack = getCommentPack(key, lang);
        return pickManualLine(pack.roots, localUsedComments, globalUsedComments);
      }

      function makeSeedReply(tpl, parentPseudo, _parentText, localUsedComments, globalUsedComments, lang = "fr") {
        const key = topicKeyFromPostLike(tpl);
        const pack = getCommentPack(key, lang);
        const line = pickManualLine(pack.replies, localUsedComments, globalUsedComments);
        return line.replace("{user}", parentPseudo);
      }

      function buildHumanCommentSetForPost(postData, totalCount, localUsed, globalUsed, lang = "fr") {
        const key = topicKeyFromPostLike(postData);
        const pack = getCommentPack(key, lang);
        const out = [];
        const shuffled = [...pack.roots].sort(() => Math.random() - 0.5);
        for (const line of shuffled) {
          if (out.length >= totalCount) break;
          const k = String(line).toLowerCase().trim();
          if (localUsed.has(k) || globalUsed.has(k)) continue;
          localUsed.add(k);
          globalUsed.add(k);
          out.push(line);
        }
        // Fallback unique par post pour éviter toute répétition visible.
        let idx = 1;
        while (out.length < totalCount) {
          const fallback =
            String(lang || "fr").toLowerCase() === "en"
              ? "Great point on this post (" + idx + ")."
              : "Très bon point sur ce post (" + idx + ").";
          const fk = fallback.toLowerCase();
          if (!localUsed.has(fk)) {
            localUsed.add(fk);
            out.push(fallback);
          }
          idx += 1;
        }
        return out;
      }

      function buildHumanReply(parentPseudo, _parentText, localUsed, globalUsed, postData = {}, lang = "fr") {
        const key = topicKeyFromPostLike(postData);
        const pack = getCommentPack(key, lang);
        for (const tpl of pack.replies) {
          const line = tpl.replace("{user}", parentPseudo);
          const k = String(line).toLowerCase().trim();
          if (localUsed.has(k) || globalUsed.has(k)) continue;
          localUsed.add(k);
          globalUsed.add(k);
          return line;
        }
        const fallback =
          String(lang || "fr").toLowerCase() === "en"
            ? "@"+ parentPseudo + " good point."
            : "@"+ parentPseudo + " bien vu.";
        const fk = fallback.toLowerCase();
        localUsed.add(fk);
        globalUsed.add(fk);
        return fallback;
      }

      async function clearSeedData() {
        const [postsSnap, usersSnap, adsSnap] = await Promise.all([
          getDocs(query(collection(db, "posts"), limit(1000))),
          getDocs(query(collection(db, "users"), limit(1000))),
          getDocs(query(collection(db, "ads"), limit(1000))),
        ]);

        const seedPosts = postsSnap.docs.filter((row) => {
          const d = row.data() || {};
          return Boolean(d.isSeed) || String(d.ownerUid || "").startsWith("seed_");
        });
        const seedUsers = usersSnap.docs.filter((row) => {
          const d = row.data() || {};
          return Boolean(d.isSeed) || String(row.id || "").startsWith("seed_");
        });
        const seedAds = adsSnap.docs.filter((row) => {
          const d = row.data() || {};
          return Boolean(d.isSeed) || String(d.ownerUid || "").startsWith("seed_");
        });

        let deletedComments = 0;

        // Supprime d'abord les commentaires des posts/pubs bots pour éviter les sous-docs orphelins.
        for (const row of seedPosts) {
          const cSnap = await getDocs(query(collection(db, "posts", row.id, "comments"), limit(1000)));
          await Promise.all(cSnap.docs.map((c) => deleteDoc(c.ref)));
          deletedComments += cSnap.size;
        }
        for (const row of seedAds) {
          const cSnap = await getDocs(query(collection(db, "ads", row.id, "comments"), limit(1000)));
          await Promise.all(cSnap.docs.map((c) => deleteDoc(c.ref)));
          deletedComments += cSnap.size;
        }

        await Promise.all(seedPosts.map((row) => deleteDoc(row.ref)));
        await Promise.all(seedAds.map((row) => deleteDoc(row.ref)));
        await Promise.all(seedUsers.map((row) => deleteDoc(row.ref)));

        return {
          users: seedUsers.length,
          posts: seedPosts.length,
          ads: seedAds.length,
          comments: deletedComments,
        };
      }

      async function seedCommunity() {
        seedCommunityBtn.disabled = true;
        seedCommunityBtn.textContent = "Seed en cours...";
        cleanupSeedBtn.disabled = true;
        try {
          const pseudoList = [
            "LinaWave","KaiSully","NoaMetkayina","MilaEywa","EnzoToruk","SaraIkran","YanisPandora","NinaBlueSky","AdamReef","LeaNaVi",
            "HugoTulkun","InesForest","RayanLoak","MayaKiri","NolanNeteyam","SofiaSpirit","ImranSkimwing","JadeAwa","TheoRDA","AyaMetkayina"
          ];
          const profiles = [];
          for (let i = 2; i <= 21; i += 1) {
            profiles.push({
              uid: "seed_" + i,
              email: i + "@gmail.com",
              pseudo: pseudoList[i - 2],
              preferredLang: i % 2 === 0 ? "fr" : "en",
            });
          }

          // Nettoyage seed avant re-génération pour éviter tout doublon.
          await clearSeedData();

          const avatarPool = [
            "assets/gallery/toruk_01.jpg",
            "assets/gallery/kiri_portrait_01.jpg",
            "assets/gallery/neteyam_portrait_01.jpg",
            "assets/gallery/neteyam_portrait_02.jpg",
            "assets/gallery/loak_portrait_01.jpg",
            "assets/gallery/loak_portrait_02.jpg",
            "assets/gallery/neytiri_portrait_01.jpg",
            "assets/gallery/neytiri_portrait_02.jpg",
            "assets/gallery/jake_neytiri_duo_01.jpg",
          ];

          const postTemplatesFr = [
            { image: "assets/gallery/neteyam_portrait_01.jpg", type: "vote", desc: "POV: Neteyam arrive et tout le monde se tait. #Neteyam #SullyFamily", q: "Ce portrait de Neteyam te donne quelle vibe ?", opts: ["Leader calme", "Protecteur", "Trop stylé", "Tout à la fois"] },
            { image: "assets/gallery/loak_portrait_01.jpg", type: "vote", desc: "Lo'ak a toujours une énergie de rebelle qui évolue. #Loak #WayOfWater", q: "Tu préfères Lo'ak en mode :", opts: ["Rebelle", "Émotion", "Action", "Humour"] },
            { image: "assets/gallery/kiri_portrait_01.jpg", type: "quiz", desc: "Kiri et son lien avec Pandora, c'est unique. #Kiri #Eywa", q: "Kiri est surtout liée à :", opts: ["Eywa", "RDA", "Quaritch", "Les avatars recom"], answer: 0 },
            { image: "assets/gallery/toruk_01.jpg", type: "vote", desc: "Toruk en plein ciel: scène légendaire. #Toruk #PandoraSky", q: "Si tu pouvais voler sur Toruk, tu ferais quoi ?", opts: ["Explorer Pandora", "Course aérienne", "Mission solo", "Photo souvenir"] },
            { image: "assets/gallery/neytiri_portrait_01.jpg", type: "quiz", desc: "Neytiri reste l'une des figures les plus fortes de la saga. #Neytiri #Omatikaya", q: "Neytiri vient du clan :", opts: ["Omatikaya", "Metkayina", "Ash People", "RDA"], answer: 0 },
            { image: "assets/gallery/jake_neytiri_duo_01.jpg", type: "vote", desc: "Le duo Jake + Neytiri est toujours iconique. #Jake #Neytiri", q: "Ce duo représente surtout :", opts: ["Famille", "Résilience", "Loyauté", "Les trois"] },
            { image: "assets/gallery/neytiri_portrait_02.jpg", type: "vote", desc: "Neytiri en posture combat: précision maximale. #Neytiri #Warrior", q: "Tu la notes combien sur ce plan ?", opts: ["10/10", "9/10", "8/10", "7/10"] },
            { image: "assets/gallery/neteyam_portrait_02.jpg", type: "quiz", desc: "Neteyam avait déjà un mindset de grand frère. #Neteyam #Sully", q: "Neteyam est :", opts: ["Le fils aîné des Sully", "Le plus jeune Sully", "Un recom", "Un soldat RDA"], answer: 0 },
            { image: "assets/gallery/loak_portrait_02.jpg", type: "vote", desc: "Lo'ak en colère: émotion brute. #Loak #Avatar", q: "Dans cette scène, tu ressens surtout :", opts: ["Colère", "Douleur", "Courage", "Les trois"] },
            { image: "assets/gallery/toruk_01.jpg", type: "quiz", desc: "Petit test lore Na'vi. #AvatarLore #NaVi", q: "Le lien neural avec les créatures se nomme :", opts: ["Tsaheylu", "Skybond", "Eywacode", "Neurobond"], answer: 0 },
            { image: "assets/gallery/kiri_portrait_01.jpg", type: "vote", desc: "Kiri a une aura très différente des autres persos. #Kiri #Mystic", q: "Kiri dans ton classement perso ?", opts: ["Top 1", "Top 3", "Top 5", "Pas encore"] },
            { image: "assets/gallery/jake_neytiri_duo_01.jpg", type: "quiz", desc: "Question casting pour les vrais fans. #AvatarQuiz #JakeSully", q: "Jake Sully est interprété par :", opts: ["Sam Worthington", "Stephen Lang", "Cliff Curtis", "Sigourney Weaver"], answer: 0 },
            { image: "assets/gallery/neytiri_portrait_01.jpg", type: "vote", desc: "Quand Neytiri fixe la caméra, c'est fini. #Neytiri #NaViQueen", q: "Tu es team Neytiri ?", opts: ["Oui à 100%", "Oui", "J'hésite", "Pas mon perso préféré"] },
            { image: "assets/gallery/neteyam_portrait_01.jpg", type: "quiz", desc: "Question famille Sully. #Neteyam #AvatarFamily", q: "Neteyam est le frère de :", opts: ["Lo'ak et Tuk", "Quaritch", "Tonowari", "Spider seulement"], answer: 0 },
            { image: "assets/gallery/loak_portrait_01.jpg", type: "vote", desc: "Lo'ak a souvent les scènes les plus imprévisibles. #Loak #Metkayina", q: "Lo'ak dans la saga c'est :", opts: ["Le plus imprévisible", "Le plus touchant", "Le plus courageux", "Un mix des 3"] },
            { image: "assets/gallery/toruk_01.jpg", type: "vote", desc: "Cette capture de Toruk mérite un fond d'écran. #Toruk #Wallpaper", q: "Tu mets ce visuel en fond d'écran ?", opts: ["Déjà fait", "Je vais le faire", "Pas mon style", "Peut-être"] },
            { image: "assets/gallery/neytiri_portrait_02.jpg", type: "quiz", desc: "Question Way of Water. #WayOfWater #Metkayina", q: "Le clan marin central du film 2 est :", opts: ["Metkayina", "Omatikaya", "Ash People", "Sky People"], answer: 0 },
            { image: "assets/gallery/neteyam_portrait_02.jpg", type: "vote", desc: "Plan serré de Neteyam: propre et intense. #Neteyam #Cinematic", q: "Ce plan est :", opts: ["Culte", "Très bon", "Correct", "Bof"] },
            { image: "assets/gallery/kiri_portrait_01.jpg", type: "quiz", desc: "Date de sortie pour vérifier les vrais. #Avatar2 #Quiz", q: "Avatar: The Way of Water est sorti en :", opts: ["2022", "2020", "2018", "2024"], answer: 0 },
            { image: "assets/gallery/jake_neytiri_duo_01.jpg", type: "vote", desc: "La saga Avatar parle d'abord de famille et de transmission. #SullyFamily #AvatarSaga", q: "Le thème central de la saga selon toi :", opts: ["Famille", "Nature", "Survie", "Les trois"] },
          ];
          const postTemplatesEn = [
            { image: "assets/gallery/neteyam_portrait_01.jpg", type: "vote", desc: "POV: Neteyam arrives and everyone goes silent. #Neteyam #SullyFamily", q: "What vibe do you get from this Neteyam portrait?", opts: ["Calm leader", "Protector", "Too stylish", "All of them"] },
            { image: "assets/gallery/loak_portrait_01.jpg", type: "vote", desc: "Lo'ak always has that evolving rebel energy. #Loak #WayOfWater", q: "Lo'ak feels more like:", opts: ["Rebel", "Emotion", "Action", "Humor"] },
            { image: "assets/gallery/kiri_portrait_01.jpg", type: "quiz", desc: "Kiri's bond with Pandora is unique. #Kiri #Eywa", q: "Kiri is mainly connected to:", opts: ["Eywa", "RDA", "Quaritch", "Recom avatars"], answer: 0 },
            { image: "assets/gallery/toruk_01.jpg", type: "vote", desc: "Toruk in the sky is a legendary scene. #Toruk #PandoraSky", q: "If you could ride Toruk, what first?", opts: ["Explore Pandora", "Aerial race", "Solo mission", "Take photos"] },
            { image: "assets/gallery/neytiri_portrait_01.jpg", type: "quiz", desc: "Neytiri remains one of the strongest figures in the saga. #Neytiri #Omatikaya", q: "Neytiri belongs to which clan?", opts: ["Omatikaya", "Metkayina", "Ash People", "RDA"], answer: 0 },
            { image: "assets/gallery/jake_neytiri_duo_01.jpg", type: "vote", desc: "Jake + Neytiri is still iconic. #Jake #Neytiri", q: "This duo mostly represents:", opts: ["Family", "Resilience", "Loyalty", "All three"] },
            { image: "assets/gallery/neytiri_portrait_02.jpg", type: "vote", desc: "Neytiri in combat stance: top precision. #Neytiri #Warrior", q: "How do you rate this shot?", opts: ["10/10", "9/10", "8/10", "7/10"] },
            { image: "assets/gallery/neteyam_portrait_02.jpg", type: "quiz", desc: "Neteyam already had an elder-brother mindset. #Neteyam #Sully", q: "Neteyam is:", opts: ["The Sully eldest son", "The youngest Sully", "A recom", "An RDA soldier"], answer: 0 },
            { image: "assets/gallery/loak_portrait_02.jpg", type: "vote", desc: "Lo'ak in anger: raw emotion. #Loak #Avatar", q: "In this scene, you mostly feel:", opts: ["Anger", "Pain", "Courage", "All three"] },
            { image: "assets/gallery/toruk_01.jpg", type: "quiz", desc: "Quick Na'vi lore test. #AvatarLore #NaVi", q: "The neural bond with creatures is called:", opts: ["Tsaheylu", "Skybond", "Eywacode", "Neurobond"], answer: 0 },
            { image: "assets/gallery/kiri_portrait_01.jpg", type: "vote", desc: "Kiri has a very different aura from other characters. #Kiri #Mystic", q: "Kiri in your ranking?", opts: ["Top 1", "Top 3", "Top 5", "Not yet"] },
            { image: "assets/gallery/jake_neytiri_duo_01.jpg", type: "quiz", desc: "Casting question for real fans. #AvatarQuiz #JakeSully", q: "Jake Sully is played by:", opts: ["Sam Worthington", "Stephen Lang", "Cliff Curtis", "Sigourney Weaver"], answer: 0 },
            { image: "assets/gallery/neytiri_portrait_01.jpg", type: "vote", desc: "When Neytiri locks in like this, debate is over. #Neytiri #NaViQueen", q: "Are you team Neytiri?", opts: ["Yes 100%", "Yes", "Not sure", "Not my favorite"] },
            { image: "assets/gallery/neteyam_portrait_01.jpg", type: "quiz", desc: "Sully family check. #Neteyam #AvatarFamily", q: "Neteyam is brother of:", opts: ["Lo'ak and Tuk", "Quaritch", "Tonowari", "Only Spider"], answer: 0 },
            { image: "assets/gallery/loak_portrait_01.jpg", type: "vote", desc: "Lo'ak often gets the most unpredictable scenes. #Loak #Metkayina", q: "Lo'ak in the saga is:", opts: ["Most unpredictable", "Most emotional", "Most brave", "Mix of all three"] },
            { image: "assets/gallery/toruk_01.jpg", type: "vote", desc: "This Toruk frame is wallpaper material. #Toruk #Wallpaper", q: "Would you use this as wallpaper?", opts: ["Already did", "I will", "Not my style", "Maybe"] },
            { image: "assets/gallery/neytiri_portrait_02.jpg", type: "quiz", desc: "Way of Water question. #WayOfWater #Metkayina", q: "The main marine clan in film 2 is:", opts: ["Metkayina", "Omatikaya", "Ash People", "Sky People"], answer: 0 },
            { image: "assets/gallery/neteyam_portrait_02.jpg", type: "vote", desc: "Close-up of Neteyam: clean and intense. #Neteyam #Cinematic", q: "This shot is:", opts: ["Cult", "Very good", "Okay", "Meh"] },
            { image: "assets/gallery/kiri_portrait_01.jpg", type: "quiz", desc: "Release date check for real fans. #Avatar2 #Quiz", q: "Avatar: The Way of Water was released in:", opts: ["2022", "2020", "2018", "2024"], answer: 0 },
            { image: "assets/gallery/jake_neytiri_duo_01.jpg", type: "vote", desc: "Avatar saga is mainly about family and transmission. #SullyFamily #AvatarSaga", q: "Core theme of the saga for you:", opts: ["Family", "Nature", "Survival", "All three"] },
          ];

          const batch = writeBatch(db);
          profiles.forEach((p, idx) => {
            batch.set(
              doc(db, "users", p.uid),
              {
                pseudo: p.pseudo,
                pseudoLower: p.pseudo.toLowerCase(),
                email: p.email,
                avatarUrl: avatarPool[idx % avatarPool.length],
                isCertified: false,
                isSeed: true,
                preferredLang: p.preferredLang,
                followersCount: randInt(4, 20),
                followingCount: randInt(4, 18),
                totalLikesReceived: randInt(10, 120),
                unlockedLevel: randInt(1, 8),
                createdAt: serverTimestamp(),
              },
              { merge: true }
            );
          });
          await batch.commit();

          const usedCommentsGlobal = new Set();
          let frIndex = 0;
          let enIndex = 0;
          for (let i = 0; i < 20; i += 1) {
            const owner = profiles[i % profiles.length];
            const lang = String(owner.preferredLang || "fr").toLowerCase() === "en" ? "en" : "fr";
            const tpl =
              lang === "en"
                ? postTemplatesEn[enIndex++ % postTemplatesEn.length]
                : postTemplatesFr[frIndex++ % postTemplatesFr.length];
            const rootCommentsCount = randInt(3, 5);
            const replyCommentsCount = randInt(1, 2);
            const commentsCount = rootCommentsCount + replyCommentsCount;
            const usedCommentsPost = new Set();
            const participants = randInt(6, 28);
            const likes = randInt(Math.ceil(participants * 0.6), participants + 20);
            const base = {
              ownerUid: owner.uid,
              ownerPseudo: owner.pseudo,
              ownerAvatarUrl: owner.avatarUrl || tpl.image,
              ownerCertified: false,
              isSeed: true,
              postLang: lang,
              targetLang: lang,
              description: tpl.desc,
              imageUrls: [tpl.image],
              postType: tpl.type,
              likesCount: likes,
              viewsCount: likes + randInt(8, 40),
              participantsCount: participants,
              commentsCount,
              createdAt: serverTimestamp(),
            };

            const postRef = await addDoc(
              collection(db, "posts"),
              tpl.type === "vote"
                ? {
                    ...base,
                    questions: [{ text: tpl.q, options: tpl.opts, correctIndex: randInt(0, tpl.opts.length - 1) }],
                    voteStats: tpl.opts.map(() => randInt(1, 10)),
                  }
                : {
                    ...base,
                    questions: [{ text: tpl.q, options: tpl.opts, correctIndex: Number(tpl.answer || 0) }],
                    voteStats: [],
                  }
            );

            const rootComments = [];
            for (let c = 0; c < rootCommentsCount; c += 1) {
              const user = pick(profiles);
              const text = makeSeedComment(tpl, usedCommentsPost, usedCommentsGlobal, lang);
              const created = await addDoc(collection(db, "posts", postRef.id, "comments"), {
                uid: user.uid,
                pseudo: user.pseudo,
                avatarUrl: pick(avatarPool),
                text,
                createdAt: serverTimestamp(),
                isSeed: true,
              });
              rootComments.push({ id: created.id, pseudo: user.pseudo, text });
            }

            for (let r = 0; r < replyCommentsCount; r += 1) {
              const parent = pick(rootComments);
              const user = pick(profiles.filter((p) => p.pseudo !== parent.pseudo));
              await addDoc(collection(db, "posts", postRef.id, "comments"), {
                uid: user.uid,
                pseudo: user.pseudo,
                avatarUrl: pick(avatarPool),
                text: makeSeedReply(tpl, parent.pseudo, parent.text, usedCommentsPost, usedCommentsGlobal, lang),
                parentId: parent.id || "",
                replyToPseudo: parent.pseudo || "",
                lang,
                createdAt: serverTimestamp(),
                isSeed: true,
              });
            }
          }
          alert("Seed terminé: 20 profils humains + 20 posts variés + interactions.");
          await loadAll();
        } catch (e) {
          console.error(e);
          alert("Erreur seed.");
        } finally {
          seedCommunityBtn.disabled = false;
          seedCommunityBtn.textContent = "Créer seed communauté";
          cleanupSeedBtn.disabled = false;
        }
      }

      async function rewriteSeedComments() {
        rewriteSeedCommentsBtn.disabled = true;
        seedCommunityBtn.disabled = true;
        cleanupSeedBtn.disabled = true;
        const prev = rewriteSeedCommentsBtn.textContent;
        rewriteSeedCommentsBtn.textContent = "Réécriture...";
        try {
          const [postsSnap, usersSnap] = await Promise.all([
            getDocs(query(collection(db, "posts"), limit(1000))),
            getDocs(query(collection(db, "users"), limit(1000))),
          ]);
          const seedProfiles = usersSnap.docs
            .map((d) => ({ uid: d.id, ...d.data() }))
            .filter((u) => Boolean(u.isSeed) || String(u.uid || "").startsWith("seed_"));
          if (!seedProfiles.length) {
            alert("Aucun bot détecté. Lance d'abord un seed.");
            return;
          }
          const seedPosts = postsSnap.docs.filter((row) => {
            const d = row.data() || {};
            return Boolean(d.isSeed) || String(d.ownerUid || "").startsWith("seed_");
          });
          let changedPosts = 0;
          let changedComments = 0;
          const globalUsed = new Set();

          for (const postRow of seedPosts) {
            const postData = postRow.data() || {};
            const lang = String(postData.postLang || "fr").toLowerCase() === "en" ? "en" : "fr";
            const cRef = collection(db, "posts", postRow.id, "comments");
            const cSnap = await getDocs(query(cRef, limit(1000)));
            const seedComments = cSnap.docs.filter((r) => {
              const d = r.data() || {};
              return Boolean(d.isSeed) || String(d.uid || "").startsWith("seed_");
            });
            const realCommentsCount = cSnap.size - seedComments.length;
            await Promise.all(seedComments.map((r) => deleteDoc(r.ref)));

            const localUsed = new Set();
            const rootCount = randInt(3, 5);
            const replyCount = randInt(1, 2);
            const roots = buildHumanCommentSetForPost(postData, rootCount, localUsed, globalUsed, lang);
            const rootRows = [];

            for (const text of roots) {
              const user = pick(seedProfiles);
              const created = await addDoc(cRef, {
                uid: user.uid,
                pseudo: user.pseudo,
                avatarUrl: user.avatarUrl || "",
                text,
                likesCount: randInt(0, 3),
                isSeed: true,
                lang,
                createdAt: serverTimestamp(),
              });
              rootRows.push({ id: created.id, pseudo: user.pseudo, text });
            }

            for (let i = 0; i < replyCount && rootRows.length; i += 1) {
              const parent = pick(rootRows);
              const user = pick(seedProfiles.filter((p) => p.pseudo !== parent.pseudo));
              await addDoc(cRef, {
                uid: user.uid,
                pseudo: user.pseudo,
                avatarUrl: user.avatarUrl || "",
                text: buildHumanReply(parent.pseudo, parent.text, localUsed, globalUsed, postData, lang),
                parentId: parent.id || "",
                replyToPseudo: parent.pseudo || "",
                likesCount: randInt(0, 2),
                isSeed: true,
                lang,
                createdAt: serverTimestamp(),
              });
            }

            const newSeedCount = rootCount + replyCount;
            await setDoc(
              doc(db, "posts", postRow.id),
              {
                commentsCount: Math.max(0, realCommentsCount + newSeedCount),
                updatedAt: serverTimestamp(),
              },
              { merge: true }
            );
            changedPosts += 1;
            changedComments += newSeedCount;
          }

          alert("Réécriture terminée: " + changedPosts + " posts mis à jour, " + changedComments + " commentaires bots recréés.");
          await loadAll();
        } catch (e) {
          console.error(e);
          alert("Erreur pendant la réécriture des commentaires bots.");
        } finally {
          rewriteSeedCommentsBtn.disabled = false;
          seedCommunityBtn.disabled = false;
          cleanupSeedBtn.disabled = false;
          rewriteSeedCommentsBtn.textContent = prev || "Réécrire commentaires bots";
        }
      }

      search.addEventListener("input", render);
      refreshBtn.addEventListener("click", () => loadAll().catch(console.error));
      cleanupSeedBtn.addEventListener("click", async () => {
        cleanupSeedBtn.disabled = true;
        seedCommunityBtn.disabled = true;
        const prevText = cleanupSeedBtn.textContent;
        cleanupSeedBtn.textContent = "Nettoyage...";
        try {
          const stats = await clearSeedData();
          alert(
            "Nettoyage terminé : " +
              stats.users +
              " users bots, " +
              stats.posts +
              " posts bots, " +
              stats.ads +
              " pubs bots, " +
              stats.comments +
              " commentaires bots supprimés."
          );
          await loadAll();
        } catch (e) {
          console.error(e);
          alert("Erreur pendant le nettoyage des bots.");
        } finally {
          cleanupSeedBtn.disabled = false;
          seedCommunityBtn.disabled = false;
          cleanupSeedBtn.textContent = prevText || "Supprimer anciens bots";
        }
      });
      rewriteSeedCommentsBtn.addEventListener("click", () => {
        rewriteSeedComments().catch(console.error);
      });
      seedCommunityBtn.addEventListener("click", () => {
        seedCommunity().catch(console.error);
      });
    </script>
  </body>
</html>
